const puppeteer = require('puppeteer');
const axios = require('axios');

// Fun√ß√£o principal de scraping ESPEC√çFICA para Vila Vix
async function scrapeVilaVixProperty(url) {
    console.log('üè† Iniciando scraping Vila Vix de:', url);
    
    const browser = await puppeteer.launch({
        headless: 'new',
        args: ['--no-sandbox', '--disable-setuid-sandbox']
    });
    
    try {
        const page = await browser.newPage();
        
        // Configurar user agent
        await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
        
        // Navegar para a p√°gina
        await page.goto(url, { 
            waitUntil: 'networkidle2',
            timeout: 30000 
        });
        
        // Aguardar conte√∫do carregar
        await page.waitForTimeout(3000);
        
        // Extrair dados do im√≥vel - ESPEC√çFICO PARA VILA VIX
        const propertyData = await page.evaluate(() => {
            console.log('Iniciando extra√ß√£o Vila Vix...');
            
            // Fun√ß√£o auxiliar para extrair texto
            const getText = (selectors) => {
                if (typeof selectors === 'string') selectors = [selectors];
                for (const selector of selectors) {
                    const el = document.querySelector(selector);
                    if (el) return el.textContent.trim();
                }
                return '';
            };
            
            // Fun√ß√£o para extrair n√∫mero
            const extractNumber = (text) => {
                if (!text) return 0;
                const cleanText = text.replace(/R\$/g, '').replace(/\./g, '').replace(',', '.');
                const match = cleanText.match(/[\d.]+/);
                return match ? parseFloat(match[0]) : 0;
            };
            
            // === EXTRA√á√ÉO DE CARACTER√çSTICAS ===
            const characteristics = {};
            
            // Vila Vix geralmente mostra caracter√≠sticas em uma estrutura espec√≠fica
            // Procurar por padr√µes de texto espec√≠ficos
            document.querySelectorAll('div, span, p, li, dt, dd').forEach(el => {
                const text = el.textContent.trim();
                const nextEl = el.nextElementSibling;
                const prevEl = el.previousElementSibling;
                
                // Tipo do Im√≥vel
                if (text === 'Tipo do Im√≥vel' && nextEl) {
                    characteristics.type = nextEl.textContent.trim();
                }
                
                // √Årea Constru√≠da
                if (text === '√Årea Constru√≠da' && nextEl) {
                    characteristics.builtArea = extractNumber(nextEl.textContent);
                }
                
                // Terreno
                if (text === 'Terreno' && nextEl) {
                    characteristics.landArea = extractNumber(nextEl.textContent);
                }
                
                // √Årea Privativa
                if (text === '√Årea Privativa' && nextEl) {
                    characteristics.privateArea = extractNumber(nextEl.textContent);
                }
                
                // Dimens√µes
                if (text === 'Dimens√µes' && nextEl) {
                    characteristics.dimensions = nextEl.textContent.trim();
                }
                
                // Dormit√≥rios
                if (text === 'Dormit√≥rios' && nextEl) {
                    const dormText = nextEl.textContent;
                    characteristics.bedrooms = extractNumber(dormText) || 0;
                    characteristics.bedroomsDetail = dormText.trim();
                }
                
                // Banheiros
                if (text === 'Banheiros' && nextEl) {
                    characteristics.bathrooms = extractNumber(nextEl.textContent);
                }
                
                // Vagas
                if (text === 'Vagas' && nextEl) {
                    characteristics.parkingSpaces = extractNumber(nextEl.textContent);
                }
                
                // Tamb√©m tentar padr√µes alternativos
                if (text.includes('dormit√≥rio') || text.includes('Dormit√≥rio')) {
                    const num = extractNumber(text);
                    if (num > 0) characteristics.bedrooms = num;
                }
                
                if (text.includes('banheiro') || text.includes('Banheiro')) {
                    const num = extractNumber(text);
                    if (num > 0) characteristics.bathrooms = num;
                }
                
                if (text.includes('vaga') || text.includes('Vaga')) {
                    const num = extractNumber(text);
                    if (num > 0) characteristics.parkingSpaces = num;
                }
            });
            
            // === EXTRA√á√ÉO DE DESCRI√á√ÉO ===
            let description = '';
            
            // Procurar por elementos que contenham "DESCRI√á√ÉO DO IM√ìVEL"
            document.querySelectorAll('*').forEach(el => {
                const text = el.textContent;
                if (text && text.includes('DESCRI√á√ÉO DO IM√ìVEL')) {
                    // Pegar o pr√≥ximo elemento ou o texto ap√≥s
                    let descEl = el.nextElementSibling;
                    if (!descEl) {
                        // Tentar pegar o elemento pai
                        descEl = el.parentElement;
                    }
                    
                    if (descEl) {
                        // Pegar todo o texto do container da descri√ß√£o
                        const fullText = descEl.textContent;
                        // Remover o t√≠tulo "DESCRI√á√ÉO DO IM√ìVEL" se estiver inclu√≠do
                        description = fullText.replace('DESCRI√á√ÉO DO IM√ìVEL', '').trim();
                    }
                }
            });
            
            // Se n√£o encontrou, tentar seletores alternativos
            if (!description) {
                description = getText([
                    '.descricao-imovel',
                    '.texto-descricao',
                    '[class*="descricao"]',
                    '.observacoes'
                ]);
            }
            
            // === EXTRA√á√ÉO DE T√çTULO ===
            const title = getText([
                'h1',
                'h2',
                '.titulo-imovel',
                '.nome-imovel',
                'meta[property="og:title"]'
            ]) || 'Im√≥vel Vila Vix';
            
            // === EXTRA√á√ÉO DE PRE√áO ===
            let price = 0;
            // Procurar por R$ em todo o documento
            document.querySelectorAll('*').forEach(el => {
                const text = el.textContent;
                if (text && text.includes('R$') && !text.includes('condom√≠nio')) {
                    const num = extractNumber(text);
                    if (num > 10000 && num < 50000000) {
                        price = num;
                    }
                }
            });
            
            // === EXTRA√á√ÉO DE ENDERE√áO ===
            const address = getText([
                '.endereco-completo',
                '.localizacao-imovel',
                '.endereco',
                '[class*="endereco"]'
            ]) || '';
            
            const neighborhood = getText([
                '.bairro',
                '.nome-bairro',
                '[class*="bairro"]'
            ]) || '';
            
            // === EXTRA√á√ÉO DE FEATURES ===
            const features = [];
            const featureSelectors = [
                '.caracteristica-item',
                '.item-caracteristica',
                '.lista-caracteristicas li',
                '.caracteristicas-imovel li',
                '.comodidades li'
            ];
            
            featureSelectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(el => {
                    const text = el.textContent.trim();
                    if (text && text.length > 2 && !features.includes(text)) {
                        features.push(text);
                    }
                });
            });
            
            // === EXTRA√á√ÉO DE IMAGENS ===
            const images = [];
            const imageSelectors = [
                '.galeria-fotos img',
                '.carousel img',
                '[class*="galeria"] img',
                '.swiper-slide img',
                'img[src*="imovel"]'
            ];
            
            imageSelectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(img => {
                    const src = img.src || img.getAttribute('data-src');
                    if (src && src.startsWith('http') && !images.includes(src)) {
                        images.push(src);
                    }
                });
            });
            
            // === MONTAR OBJETO FINAL ===
            return {
                title,
                price: price || 750000,
                address,
                neighborhood,
                // Usar os valores extra√≠dos das caracter√≠sticas
                bedrooms: characteristics.bedrooms || 3,
                bathrooms: characteristics.bathrooms || 2,
                area: characteristics.builtArea || characteristics.privateArea || 100,
                type: characteristics.type || 'Im√≥vel',
                description: description || 'Descri√ß√£o n√£o dispon√≠vel',
                features,
                images: images.slice(0, 10),
                // Dados adicionais espec√≠ficos do Vila Vix
                characteristics: {
                    type: characteristics.type,
                    builtArea: characteristics.builtArea,
                    landArea: characteristics.landArea,
                    privateArea: characteristics.privateArea,
                    dimensions: characteristics.dimensions,
                    bedroomsDetail: characteristics.bedroomsDetail,
                    parkingSpaces: characteristics.parkingSpaces
                }
            };
        });
        
        // Log dos dados extra√≠dos
        console.log('üìä Dados extra√≠dos:');
        console.log('- T√≠tulo:', propertyData.title);
        console.log('- Pre√ßo:', propertyData.price);
        console.log('- Tipo:', propertyData.type);
        console.log('- Quartos:', propertyData.bedrooms);
        console.log('- Banheiros:', propertyData.bathrooms);
        console.log('- √Årea:', propertyData.area, 'm¬≤');
        console.log('- Caracter√≠sticas:', propertyData.characteristics);
        console.log('- Descri√ß√£o:', propertyData.description.substring(0, 100) + '...');
        
        // Adicionar ID √∫nico
        propertyData.id = 'prop_' + Date.now();
        
        // Geocodificar endere√ßo
        const fullAddress = `${propertyData.address}, ${propertyData.neighborhood}, ES, Brasil`;
        const coordinates = await geocodeAddress(fullAddress);
        propertyData.latitude = coordinates.lat;
        propertyData.longitude = coordinates.lng;
        
        // Buscar amenidades
        propertyData.amenities = await findNearbyAmenities(coordinates.lat, coordinates.lng);
        
        // Calcular dist√¢ncia da praia
        const beachAmenity = propertyData.amenities.find(a => a.type === 'Praia');
        propertyData.beachDistance = beachAmenity ? beachAmenity.distanceMeters : calculateBeachDistance(coordinates.lat, coordinates.lng);
        
        console.log('‚úÖ Scraping conclu√≠do com sucesso!');
        return propertyData;
        
    } catch (error) {
        console.error('‚ùå Erro no scraping:', error);
        throw error;
    } finally {
        await browser.close();
    }
}

// === FUN√á√ïES AUXILIARES (mantidas do original) ===

async function geocodeAddress(address) {
    try {
        const apiKey = process.env.GOOGLE_MAPS_API_KEY;
        console.log('üìç Geocodificando:', address);
        const encodedAddress = encodeURIComponent(address);
        const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${apiKey}`;
        
        const response = await axios.get(url);
        
        if (response.data.results && response.data.results.length > 0) {
            const location = response.data.results[0].geometry.location;
            console.log('‚úÖ Coordenadas:', location);
            return location;
        }
        
        console.log('‚ö†Ô∏è Usando coordenadas padr√£o de Vila Velha');
        return { lat: -20.3333, lng: -40.2833 };
    } catch (error) {
        console.error('‚ùå Erro ao geocodificar:', error.message);
        return { lat: -20.3333, lng: -40.2833 };
    }
}

async function findNearbyAmenities(lat, lng) {
    try {
        const apiKey = process.env.GOOGLE_MAPS_API_KEY;
        const amenities = [];
        
        const placeTypes = [
            { type: 'pharmacy', name: 'Farm√°cia', icon: 'üíä' },
            { type: 'gym', name: 'Academia', icon: 'üèãÔ∏è‚Äç‚ôÄÔ∏è' },
            { type: 'shopping_mall', name: 'Shopping', icon: 'üõçÔ∏è' },
            { type: 'supermarket', name: 'Supermercado', icon: 'üõí' },
            { type: 'restaurant', name: 'Restaurante', icon: 'üçΩÔ∏è' },
            { type: 'bank', name: 'Banco', icon: 'üè¶' },
            { type: 'hospital', name: 'Hospital', icon: 'üè•' },
            { type: 'school', name: 'Escola', icon: 'üè´' }
        ];
        
        console.log(`üîç Buscando amenidades pr√≥ximas...`);
        
        for (const placeType of placeTypes) {
            const url = `https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${lat},${lng}&radius=3000&type=${placeType.type}&key=${apiKey}&language=pt-BR`;
            
            try {
                const response = await axios.get(url);
                
                if (response.data.results && response.data.results.length > 0) {
                    const places = response.data.results.slice(0, 3);
                    
                    for (const place of places) {
                        const distanceKm = calculateDistance(lat, lng, place.geometry.location.lat, place.geometry.location.lng);
                        const distanceMeters = Math.round(distanceKm * 1000);
                        
                        amenities.push({
                            id: 'am_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: place.name,
                            type: placeType.name,
                            distance: distanceKm,
                            distanceMeters: distanceMeters,
                            address: place.vicinity || 'Endere√ßo n√£o dispon√≠vel',
                            latitude: place.geometry.location.lat,
                            longitude: place.geometry.location.lng,
                            rating: place.rating || null,
                            icon: placeType.icon
                        });
                    }
                }
            } catch (error) {
                console.error(`‚ö†Ô∏è Erro ao buscar ${placeType.name}:`, error.message);
            }
        }
        
        // Buscar praia
        try {
            const beachUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=praia&location=${lat},${lng}&radius=5000&key=${apiKey}&language=pt-BR`;
            const beachResponse = await axios.get(beachUrl);
            
            if (beachResponse.data.results && beachResponse.data.results.length > 0) {
                const beach = beachResponse.data.results[0];
                const beachDistanceKm = calculateDistance(lat, lng, beach.geometry.location.lat, beach.geometry.location.lng);
                const beachDistanceMeters = Math.round(beachDistanceKm * 1000);
                
                amenities.push({
                    id: 'am_beach_' + Date.now(),
                    name: beach.name,
                    type: 'Praia',
                    distance: beachDistanceKm,
                    distanceMeters: beachDistanceMeters,
                    address: beach.formatted_address || 'Praia',
                    latitude: beach.geometry.location.lat,
                    longitude: beach.geometry.location.lng,
                    rating: beach.rating || null,
                    icon: 'üèñÔ∏è'
                });
            }
        } catch (error) {
            console.error('‚ö†Ô∏è Erro ao buscar praia:', error.message);
        }
        
        amenities.sort((a, b) => a.distance - b.distance);
        console.log(`‚úÖ Encontradas ${amenities.length} amenidades`);
        return amenities;
        
    } catch (error) {
        console.error('‚ùå Erro ao buscar amenidades:', error);
        return getMockAmenities(lat, lng);
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function toRad(deg) {
    return deg * (Math.PI/180);
}

function calculateBeachDistance(lat, lng) {
    const beachLat = -20.3305;
    const beachLng = -40.2855;
    const distance = calculateDistance(lat, lng, beachLat, beachLng);
    return Math.round(distance * 1000);
}

function getMockAmenities(lat, lng) {
    const baseAmenities = [
        { name: 'Farm√°cia Pacheco', type: 'Farm√°cia', offset: { lat: 0.002, lng: 0.001 }, icon: 'üíä' },
        { name: 'Smart Fit', type: 'Academia', offset: { lat: -0.001, lng: 0.002 }, icon: 'üèãÔ∏è‚Äç‚ôÄÔ∏è' },
        { name: 'Shopping Vila Velha', type: 'Shopping', offset: { lat: 0.005, lng: -0.003 }, icon: 'üõçÔ∏è' },
        { name: 'Supermercado Extrabom', type: 'Supermercado', offset: { lat: -0.002, lng: -0.001 }, icon: 'üõí' },
        { name: 'Restaurante Sabor da Terra', type: 'Restaurante', offset: { lat: 0.001, lng: -0.002 }, icon: 'üçΩÔ∏è' },
        { name: 'Praia da Costa', type: 'Praia', offset: { lat: -0.003, lng: 0.004 }, icon: 'üèñÔ∏è' }
    ];
    
    return baseAmenities.map((amenity, index) => {
        const distance = parseFloat((Math.random() * 1.5 + 0.1).toFixed(1));
        const distanceMeters = Math.round(distance * 1000);
        
        return {
            id: 'am_' + Date.now() + '_' + index,
            name: amenity.name,
            type: amenity.type,
            distance: distance,
            distanceMeters: distanceMeters,
            address: 'Vila Velha, ES',
            latitude: lat + amenity.offset.lat,
            longitude: lng + amenity.offset.lng,
            icon: amenity.icon
        };
    });
}

module.exports = {
    scrapeVilaVixProperty
};